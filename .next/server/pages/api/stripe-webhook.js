"use strict";(()=>{var e={};e.id=550,e.ids=[550],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},4217:e=>{e.exports=require("micro")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},1128:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{config:()=>l,default:()=>c,routeModule:()=>d});var s=t(1802),n=t(7153),a=t(6249),i=t(875),u=e([i]);i=(u.then?(await u)():u)[0];let c=(0,a.l)(i,"default"),l=(0,a.l)(i,"config"),d=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/stripe-webhook",pathname:"/api/stripe-webhook",bundlePath:"",filename:""},userland:i});o()}catch(e){o(e)}})},2020:(e,r,t)=>{t.d(r,{R:()=>o});let o=(0,t(2885).createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1}})},875:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{config:()=>l,default:()=>u});var s=t(4217),n=t(6090),a=t(2020),i=e([n]);let c=new(n=(i.then?(await i)():i)[0]).default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),l={api:{bodyParser:!1}};async function u(e,r){let t;if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let o=await (0,s.buffer)(e),n=e.headers["stripe-signature"];if(!n)return console.error("Missing stripe-signature header"),r.status(400).json({error:"Missing signature"});try{t=c.webhooks.constructEvent(o,n,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e),r.status(400).json({error:"Invalid signature"})}console.log("Received Stripe event:",t.type,t.id);try{if("checkout.session.completed"===t.type){let e=t.data.object;console.log("Processing checkout session:",e.id);let o=Number(e.metadata?.userId),s=e.amount_total||0;if(!o||!s)return console.error("Missing userId or amountCents:",{userId:o,amountCents:s}),r.status(400).json({error:"Invalid session metadata"});let{error:n}=await a.R.from("wallet_tx").insert({telegram_id:o,amount_cents:s,kind:"topup",provider:"stripe_gpay",status:"succeeded",stripe_session_id:e.id,description:`Wallet top-up via Stripe: $${(s/100).toFixed(2)}`});if(n)return console.error("Failed to insert transaction:",n),r.status(500).json({error:"Database error"});let{data:i,error:u}=await a.R.rpc("wallet_increment",{p_user:o,p_amount_cents:s});if(u)return console.error("Failed to increment balance:",u),r.status(500).json({error:"Failed to update balance"});console.log(`Successfully processed payment for user ${o}: +$${(s/100).toFixed(2)}, new balance: $${((i||0)/100).toFixed(2)}`)}r.status(200).json({ok:!0})}catch(e){console.error("Webhook processing error:",e),r.status(500).json({error:"Webhook processing failed",details:e instanceof Error?e.message:"Unknown error"})}}o()}catch(e){o(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=1128);module.exports=t})();