"use strict";(()=>{var e={};e.id=200,e.ids=[200],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2465:(e,t,r)=>{r.r(t),r.d(t,{config:()=>f,default:()=>p,routeModule:()=>m});var a={};r.r(a),r.d(a,{default:()=>l});var n=r(1802),o=r(7153),s=r(6249),i=r(8456),u=r(675);async function l(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r=(0,u.verifyTelegramAuth)(e.body.initData||{});if(!r)return t.status(401).json({error:"Unauthorized"});let{amount:a,currency:n="RUB",paymentToken:o,paymentMethodData:s}=e.body;if(!a||a<=0||a>1e5)return t.status(400).json({error:"Invalid amount. Must be between 1 and 100,000 RUB"});if(!o)return t.status(400).json({error:"Payment token is required"});let l=`gpy_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=s?.paymentMethodToken||null;try{let e=await c({amount:a,currency:n,paymentToken:o,paymentId:l});if(!e.success)return t.status(400).json({error:"Payment failed",details:e.error});let{data:s,error:u}=await i.p.rpc("update_wallet_balance",{p_user_id:r.id,p_amount:parseFloat(a),p_transaction_type:"deposit",p_description:`Пополнение баланса через Google Pay`,p_payment_method:"google_pay",p_payment_id:l,p_external_id:p});if(u)return console.error("Database error:",u),await d(l),t.status(500).json({error:"Failed to update balance",details:u.message});let{data:f}=await i.p.from("wallets").select("balance").eq("user_id",r.id).eq("currency","RUB").eq("is_active",!0).single();t.status(200).json({success:!0,transaction_id:s,payment_id:l,amount:parseFloat(a),currency:n,new_balance:f?.balance||0,message:"Баланс успешно пополнен!"})}catch(e){console.error("Payment processing error:",e),t.status(500).json({error:"Payment processing failed",details:e.message})}}catch(e){console.error("Google Pay API error:",e),t.status(500).json({error:"Internal server error"})}}async function c({amount:e,currency:t,paymentToken:r,paymentId:a}){await new Promise(e=>setTimeout(e,1e3));let n=Math.random();return n<.05?{success:!1,error:"Payment declined by bank"}:n<.1?{success:!1,error:"Insufficient funds"}:{success:!0,transaction_id:`gpy_trans_${a}`,status:"completed"}}async function d(e){return console.log(`Cancelling Google Pay payment: ${e}`),!0}let p=(0,s.l)(a,"default"),f=(0,s.l)(a,"config"),m=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/wallet/googlepay",pathname:"/api/wallet/googlepay",bundlePath:"",filename:""},userland:a})},8456:(e,t,r)=>{r.d(t,{p:()=>s});var a=r(2885);let n=process.env.NEXT_PUBLIC_SUPABASE_URL,o=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!n||!o)throw Error("Missing Supabase environment variables");(0,a.createClient)(n,o);let s=(0,a.createClient)(n,process.env.SUPABASE_SERVICE_ROLE||o,{auth:{autoRefreshToken:!1,persistSession:!1}})},675:(e,t,r)=>{r.d(t,{wR:()=>o,OI:()=>s});let a=require("crypto");var n=r.n(a);function o(e){let t=new URLSearchParams(e),r={};for(let[e,a]of t.entries())r[e]=a;return r}function s(e,t,r=86400){if(!e)return{ok:!1,reason:"No initData provided"};if(!t)return{ok:!1,reason:"Missing BOT_TOKEN on server"};let a=o(e),s=(a.hash||"").toLowerCase();if(!s)return{ok:!1,reason:"Missing hash in initData"};if(a.auth_date){let e=Math.floor(Date.now()/1e3)-Number(a.auth_date);if(Number.isFinite(e)&&e>r)return{ok:!1,reason:"initData is too old"}}let i=n().createHmac("sha256","WebAppData").update(t).digest(),u=Object.keys(a).filter(e=>"hash"!==e).sort().map(e=>`${e}=${a[e]}`).join("\n"),l=n().createHmac("sha256",i).update(u).digest("hex");return n().timingSafeEqual(Buffer.from(l,"hex"),Buffer.from(s,"hex"))?{ok:!0}:{ok:!1,reason:"Hash mismatch"}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2465);module.exports=r})();