"use strict";(()=>{var e={};e.id=609,e.ids=[609],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},7494:(e,r,t)=>{t.r(r),t.d(r,{config:()=>p,default:()=>f,routeModule:()=>c});var a={};t.r(a),t.d(a,{config:()=>l,default:()=>d});var o=t(1802),n=t(7153),s=t(6249),i=t(675),u=t(8456);let l={runtime:"nodejs"};async function d(e,r){if("POST"!==e.method)return r.setHeader("Allow",["POST"]),r.status(405).json({ok:!1,error:"Method Not Allowed"});try{let t=process.env.TELEGRAM_BOT_TOKEN;if(!t)return r.status(500).json({ok:!1,error:"Missing TELEGRAM_BOT_TOKEN on server"});let a="string"==typeof e.body?e.body:e.body&&e.body.initData||"";if(!a)return r.status(400).json({ok:!1,error:"No initData provided"});let o=(0,i.OI)(a,t);if(!o.ok)return r.status(401).json({ok:!1,error:o.reason||"Invalid initData"});let n=(0,i.wR)(a),s=null;try{s=n.user?JSON.parse(n.user):null}catch(e){return r.status(400).json({ok:!1,error:"Bad user payload in initData"})}let l=s?{id:s.id,first_name:s.first_name||"",last_name:s.last_name||"",username:s.username||"",photo_url:s.photo_url||""}:null;if(l)try{let{data:e,error:r}=await u.p.from("users").upsert([{telegram_id:l.id,first_name:l.first_name,last_name:l.last_name,username:l.username,photo_url:l.photo_url,last_login:new Date().toISOString()}],{onConflict:"telegram_id"});r?console.error("Supabase error:",r):console.log("User saved to Supabase:",e)}catch(e){console.error("Supabase connection error:",e)}return r.status(200).json({ok:!0,profile:l})}catch(e){return console.error("[api/auth/telegram] error:",e),r.status(500).json({ok:!1,error:"Server error"})}}let f=(0,s.l)(a,"default"),p=(0,s.l)(a,"config"),c=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/telegram",pathname:"/api/auth/telegram",bundlePath:"",filename:""},userland:a})},8456:(e,r,t)=>{t.d(r,{p:()=>s});var a=t(2885);let o=process.env.NEXT_PUBLIC_SUPABASE_URL,n=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!o||!n)throw Error("Missing Supabase environment variables");(0,a.createClient)(o,n);let s=(0,a.createClient)(o,process.env.SUPABASE_SERVICE_ROLE||n,{auth:{autoRefreshToken:!1,persistSession:!1}})},675:(e,r,t)=>{t.d(r,{wR:()=>n,OI:()=>s});let a=require("crypto");var o=t.n(a);function n(e){let r=new URLSearchParams(e),t={};for(let[e,a]of r.entries())t[e]=a;return t}function s(e,r,t=86400){if(!e)return{ok:!1,reason:"No initData provided"};if(!r)return{ok:!1,reason:"Missing BOT_TOKEN on server"};let a=n(e),s=(a.hash||"").toLowerCase();if(!s)return{ok:!1,reason:"Missing hash in initData"};if(a.auth_date){let e=Math.floor(Date.now()/1e3)-Number(a.auth_date);if(Number.isFinite(e)&&e>t)return{ok:!1,reason:"initData is too old"}}let i=o().createHmac("sha256","WebAppData").update(r).digest(),u=Object.keys(a).filter(e=>"hash"!==e).sort().map(e=>`${e}=${a[e]}`).join("\n"),l=o().createHmac("sha256",i).update(u).digest("hex");return o().timingSafeEqual(Buffer.from(l,"hex"),Buffer.from(s,"hex"))?{ok:!0}:{ok:!1,reason:"Hash mismatch"}}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=7494);module.exports=t})();