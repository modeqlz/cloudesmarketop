"use strict";(()=>{var e={};e.id=609,e.ids=[609],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},8422:(e,r,t)=>{t.r(r),t.d(r,{config:()=>m,default:()=>c,routeModule:()=>_});var a={};t.r(a),t.d(a,{config:()=>f,default:()=>p});var o=t(1802),n=t(7153),s=t(6249);let i=require("crypto");var u=t.n(i);function l(e){let r=new URLSearchParams(e),t={};for(let[e,a]of r.entries())t[e]=a;return t}var d=t(8456);let f={runtime:"nodejs"};async function p(e,r){if("POST"!==e.method)return r.setHeader("Allow",["POST"]),r.status(405).json({ok:!1,error:"Method Not Allowed"});try{let t=process.env.TELEGRAM_BOT_TOKEN;if(!t)return r.status(500).json({ok:!1,error:"Missing TELEGRAM_BOT_TOKEN on server"});let a="string"==typeof e.body?e.body:e.body&&e.body.initData||"";if(!a)return r.status(400).json({ok:!1,error:"No initData provided"});let o=function(e,r,t=86400){if(!e)return{ok:!1,reason:"No initData provided"};if(!r)return{ok:!1,reason:"Missing BOT_TOKEN on server"};let a=l(e),o=(a.hash||"").toLowerCase();if(!o)return{ok:!1,reason:"Missing hash in initData"};if(a.auth_date){let e=Math.floor(Date.now()/1e3)-Number(a.auth_date);if(Number.isFinite(e)&&e>t)return{ok:!1,reason:"initData is too old"}}let n=u().createHmac("sha256","WebAppData").update(r).digest(),s=Object.keys(a).filter(e=>"hash"!==e).sort().map(e=>`${e}=${a[e]}`).join("\n"),i=u().createHmac("sha256",n).update(s).digest("hex");return u().timingSafeEqual(Buffer.from(i,"hex"),Buffer.from(o,"hex"))?{ok:!0}:{ok:!1,reason:"Hash mismatch"}}(a,t);if(!o.ok)return r.status(401).json({ok:!1,error:o.reason||"Invalid initData"});let n=l(a),s=null;try{s=n.user?JSON.parse(n.user):null}catch(e){return r.status(400).json({ok:!1,error:"Bad user payload in initData"})}let i=s?{id:s.id,first_name:s.first_name||"",last_name:s.last_name||"",username:s.username||"",photo_url:s.photo_url||""}:null;if(i)try{let{data:e,error:r}=await d.p.from("users").upsert([{telegram_id:i.id,first_name:i.first_name,last_name:i.last_name,username:i.username,photo_url:i.photo_url,last_login:new Date().toISOString()}],{onConflict:"telegram_id"});r?console.error("Supabase error:",r):console.log("User saved to Supabase:",e)}catch(e){console.error("Supabase connection error:",e)}return r.status(200).json({ok:!0,profile:i})}catch(e){return console.error("[api/auth/telegram] error:",e),r.status(500).json({ok:!1,error:"Server error"})}}let c=(0,s.l)(a,"default"),m=(0,s.l)(a,"config"),_=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/telegram",pathname:"/api/auth/telegram",bundlePath:"",filename:""},userland:a})},8456:(e,r,t)=>{t.d(r,{p:()=>s});var a=t(2885);let o=process.env.NEXT_PUBLIC_SUPABASE_URL,n=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!o||!n)throw Error("Missing Supabase environment variables");(0,a.createClient)(o,n);let s=(0,a.createClient)(o,process.env.SUPABASE_SERVICE_ROLE||n,{auth:{autoRefreshToken:!1,persistSession:!1}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=8422);module.exports=t})();